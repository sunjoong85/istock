<!DOCTYPE>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
  </head>
  <body>
    <h1>iStock - Monitoring Investment Factors</h1>
    <div style='position: relative;margin: auto;height: 100vh;width: 100vw;'>
      <canvas id='canvas'></canvas>
    </div>

  </body>
  <script>
  //모바일 사이즈
  Chart.defaults.global.defaultFontSize=20;

  var req = new XMLHttpRequest();
  req.open('GET', '/traderTrend', true);
  req.onreadystatechange = function (aEvt) {
    if (req.readyState == 4) {
       console.log(req.responseText);
       let data = JSON.parse(req.responseText);

       let label = [];
       let indivisual = [];
       let foreigner = [];
       let institutional = [];
       let kospiPriceIndexes = [];

       data.forEach(function(o) {
          var d = new Date(o.date);
          d = d.getFullYear() + '.' + (d.getMonth()*1+1) + '.' + d.getDate();

          label.push(d);
          indivisual.push(o.개인);
          foreigner.push(o.외국인);
          institutional.push(o.기관);
          kospiPriceIndexes.push(o.priceIndex);
       })

       config.data.labels = label;
       config.data.datasets[0].data = indivisual;
       config.data.datasets[1].data = foreigner;
       config.data.datasets[2].data = institutional;
       config.data.datasets[3].data = kospiPriceIndexes;

	      window.myLine.update();

       if(req.status == 200){
       }
    }
  };
  req.send(null);

  window.chartColors = {
  	red: 'rgb(255, 99, 132)',
  	orange: 'rgb(255, 159, 64)',
  	yellow: 'rgb(255, 205, 86)',
  	green: 'rgb(75, 192, 192)',
  	blue: 'rgb(54, 162, 235)',
  	purple: 'rgb(153, 102, 255)',
  	grey: 'rgb(201, 203, 207)'
  };

    var config = {
			type: 'line',
			data: {
				labels: [],
				datasets: [{
					label: '개인',
          fill: false,
					backgroundColor: window.chartColors.red,
					borderColor: window.chartColors.red,
					data: [],
          yAxisID : 'y-axis-1'

				}, {
					label: '외국인',
					fill: false,
					backgroundColor: window.chartColors.blue,
					borderColor: window.chartColors.blue,
					data: [],
          yAxisID : 'y-axis-1'
				},
        {
          label: '기관',
          fill: false,
          backgroundColor: window.chartColors.yellow,
          borderColor: window.chartColors.yellow,
          data: [],
          yAxisID : 'y-axis-1'
        },
        {
          label: 'KOSPI',
          fill: false,
          backgroundColor: window.chartColors.grey,
          borderColor: window.chartColors.grey,
          borderDash : [5],
          data: [],
          yAxisID: 'y-axis-2'
        }]
			},

			options: {
        elements: {
           line: {
               tension: 0, // disables bezier curves
           }
        },
				responsive: true,
				title: {
					display: true,
					text: '투자자별매매동향(KOSPI)',
          fontSize : 28
				},
				tooltips: {
					mode: 'index',
					intersect: false
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: '매매동향/억원'
						},
            id: 'y-axis-1'
					},
          { display: true,
            position: 'right',
            id: 'y-axis-2',
            scaleLabel: {
              display: true,
              labelString : 'KOSPI'
            },
            ticks: {
              stepSize : 5
            }
          }]
				}
			}
		};

		window.onload = function() {
			var ctx = document.getElementById('canvas').getContext('2d');
			window.myLine = new Chart(ctx, config);
		};

  </script>
</html>
